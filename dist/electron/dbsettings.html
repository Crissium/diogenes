<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Diogenes Database Settings</title>
    <script type="text/javascript">
const {app} = require('electron')
const path = require('path');
const fs = require('fs');
const console = require('console');

var settingsDir = app.getPath('userData')
var settingsFile = path.join(settingsDir, 'diogenes.prefs');

function setPath(dbName, folderPath) {
    // check if folderPath is defined.
    fs.readFile(settingsFile, 'utf8', (err, data) => {
        if (err) {
            console.log('No prefs file found at ' + settingsFile);
            data = '# Created by electron';
        }
        var dir = dbName.toLowerCase() + '_dir';
        var newLine = dir + ' "' + folderPath + '"';
        var re = new RegExp('^'+dir+'.*$', 'm');
        var newData;
        if (re.test(data)) {
            newData = data.replace(re, newLine);
        }
        else {
            newData = data + "\n" + newLine;
        }
        fs.writeFile(settingsFile, newData, (err) => {
            if (err) {
                alert ("Writing settings failed!");
                throw err;
            }
            console.log("Written " + settingsFile);
        });
    });
    showPath(dbName, folderPath);
}

function showPath (dbName, folderPath) {
    var showPath = document.querySelector('#'+dbName+'path');
    showPath.innerHTML = folderPath;
}

function bindChangeEvent (dbName) {
    var inputField = document.querySelector('#'+dbName);
    inputField.addEventListener('change', function () {
        var folderPath = this.value;
        setPath(dbName, folderPath);
    }, false);
    inputField.click();
}

function bindClickEvent (dbName) {
    var button = document.querySelector('#'+dbName+'button');
    button.addEventListener('click', function () {
        bindChangeEvent(dbName);
    });
}

window.onload = function () {
    // Set up click events
    bindClickEvent('PHI');
    bindClickEvent('TLG');
    bindClickEvent('DDP');
    button = document.querySelector('#close');
    button.addEventListener('click', function () {
        window.close()
    });

    // Create settings dir, if necessary
    if (! fs.existsSync(settingsDir)) {
        fs.mkdir(path, function (e) {
            if (e) throw e;
            console.log("Created directory " + path);
        });
    }
    // Read existing db settings
    fs.readFile(settingsFile, (err, data) => {
        if (!err) {
            console.log("Reading " + settingsFile);
            var reTLG = /^tlg_dir\s+"?(.*?)"?$/m;
            var rePHI = /^phi_dir\s+"?(.*?)"?$/m;
            var reDDP = /^ddp_dir\s+"?(.*?)"?$/m;
            var ar;
            ar = reTLG.exec(data);
            if (ar) {
                showPath('TLG', ar[1]);
            }
            ar = rePHI.exec(data);
            if (ar) {
                showPath('PHI', ar[1]);
            }
            ar = reDDP.exec(data);
            if (ar) {
                showPath('DDP', ar[1]);
            }
        }
    });

    console.log('loaded');

    
};
    </script> 
    <style type="text/css">
      .pathArea {
      overflow-x: scroll;
      white-space: nowrap;
      }
      .button {
      border: 2px solid #AAA;
      border-radius: 4px;
      padding: 2px 5px;
      margin: 6px;
      background: #DDD;
      display: inline-block;
      }
      .button:hover {
      background: #CCC;
      }
      .button:active {
      background: #CCF;
      }
      .button:invalid + span {
      color: #A44;
      }
      .path {
      color: #999;
      }      
    </style>
  </head>
  <body>
    <input type="file" id="PHI" style="display: none;" />
    <input type="file" id="TLG" style="display: none;" />
    <input type="file" id="DDP" style="display: none;" />
    <h1>Set Database Locations</h1>
    <p>Diogenes needs to know where on your computer the databases of ancient texts are located.  These are not distributed with Diogenes; they must be acquired separately.</p>
    <p>Click the buttons below to set the locations of the databases.</p>
    <div class="pathArea">
      <div class="button" id="PHIbutton">
        PHI (Latin)
      </div>
      <span class ="path" id="PHIpath"></span>
      <br/>
      <div class="button" id="TLGbutton">
        TLG (Greek)
      </div>
      <span class ="path" id="TLGpath"></span>
      <br/>
      <div class="button" id="DDPbutton">
        DDP (Papyri, etc.)
      </div>
      <span class ="path" id="DDPpath"></span>
    </div>
    &nbsp;<br/>
    <center>
      <input type="submit" value="Close" id="close" />
    </center>
    <a href="http://localhost:8888">To Diogenes!</a><!-- TODO: set this to the correct port with js -->
  </body>
</html>
